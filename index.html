<!doctype html>
<html lang="en">

<head>
  <title>Chat With Us</title>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS v5.2.1 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        .container{
            font-family: 'Poppins', sans-serif;
            max-width: 992px;
            margin: 0 auto;
        }
        .form-control{
            background: #FFFFFF;
            border: 1px solid #8C8C8C;
            border-radius: 30px;
            padding: 12px 24px;
            font-family: 'Poppins';
            font-weight: 400;
            font-size: 18px;
            color: #A3A3A3;
        }
       
        .btn-primary{
            background: #337443;
            border-radius: 30px;
            padding: 12px 24px;
            font-family: 'Poppins';
            font-weight: 600;
            font-size: 16px;
            color: #FFFFFF;
            border-color: #337443;
        }
        .btn-primary:hover{
            background: #1c532a !important;
            border-color: #1c532a;
            color: #FFFFFF !important;
        }
        .w20{
            width: 20px;
        }
        .logo{
            width: 80%;
        }
        #loading{
            width: 45px;
            display: none;
        }

        @media screen and (max-width: 576px){
            .logo{
                width: 100%;
            }
            .card-body{
                margin-bottom: 45px;
                text-align: center;
            }
        }
    </style>
</head>

<body>
 
    <section>
        <div class="container">
            <div class="row row align-items-end">
                <div class="col-md-6">
                    <img src="./images/dowell-logo.png" alt="" class="img-fluid logo">
                    <div class="card-body">
                        <form id="userChatForm" method="POST">
                            <div class="input-group mb-4">
                                <input name="user_name" type="text" class="form-control" placeholder="Enter your Name" id="user_name"> 
                            </div>

                            <!-- dropdown -->
                            <!-- <div class="input-group mb-4">
                                <select name="product" class="form-control" id="user_department">
                                    <option value="">Select Product</option>
                                    <option value="Dowell Chat">Dowell Chat</option>
                                    <option value="Wifi QR code">Wifi QR code</option>
                                    <option value="Digital Q">Digital Q</option>
                                    <option value="Workflow AI">Workflow AI</option>
                                </select>
                            </div> -->
                          <!-- Radios -->
                            <!-- Select a Product Heading -->
                            <!-- <div class="input-group mb-2">
                                <h5 class="">Select a Product</h5>
                            </div>
                            <div class="input-group mb-4">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="product" id="product" value="DowellChat">
                                    <label class="form-check-label" for="product">DowellChat</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="product" id="product" value="DigitalQ">
                                    <label class="form-check-label" for="product">DigitalQ</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="product" id="product" value="WorkflowAi">
                                    <label class="form-check-label" for="product">WorkflowAi</label>
                                </div>
                            </div> -->

                            <div class="d-flex align-items-center">
                                <button type="submit" class="btn btn-primary d-flex gap-3" id="userChatBtn">Start Chat <img src="./images/arrow-right.svg" alt="" class="img-fluid w20"> </button>
                                <div id="loading">
                                    <img src="./images/loading.gif" alt="" class="img-fluid loading">
                                </div>
                            </div>
                        </form>
                      
                    </div>
                </div>
                <div class="col-md-6">
                    <img src="./images/hero.svg" alt="" class="img-fluid">
                </div>
            </div>
        </div>
    </section>


  <!-- Bootstrap JavaScript Libraries -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
    integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous">
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.min.js"
    integrity="sha384-7VPbUDkoPSGFnVtYi0QogXtr74QeVeeIs99Qfg5YCF+TidwNdjvaKZX19NZ/e6oz" crossorigin="anonymous">
  </script> -->


  <!-- add jquery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
    const userChatBtn = document.querySelector('#userChatBtn');
    
    if (userChatBtn){
        userChatBtn.addEventListener('click',linkBasedLogin)
    }
    else{
        console.log('userChatBtn not found');
    }
    
    
    
    function linkBasedLogin(){
        event.preventDefault();
       

        const formData = new FormData(document.getElementById('userChatForm'));
        //console.log(formData);
        //convert to json
        const formdata = Object.fromEntries(formData.entries());
        console.log(formdata);
    
        const user_name = formdata['user_name'];
        localStorage.setItem('user_name',user_name);
        localStorage.setItem('product','DigitalQ');
        //dont send empty names
        if (user_name === ''){
            return false;
        }
        document.querySelector('#loading').style.display = 'block';
    
        //const user_name ='Bickky'
        const os = 'osver';
        const device = 'device';
        const browser = 'brow';
        const location = 'loc';
        const time='str(ltime)';
        const connection = 'mobconn';
        const ip = 'ipuser';
        const data = {
                'Username':user_name,
                'OS':os,
                'Device': device,
                'Browser': browser,
                'Location': location,
                'Time': time,
                'Connection': connection,
                'IP': ip,
            };
        console.log(data);
    
        $.ajax({
            url:'https://100014.pythonanywhere.com/api/linkbased/',
            type:'POST',
            data:data,
            
            success: function (data) {
                console.log(data);
                //call create room api
            
                const newdata = {
                    "user_name":user_name,
                    "qrid":data['qrid'],
                    "product":'DigitalQ',
                    
                }
                console.log(newdata);
                createRoom(newdata);
            },
            error: function (data) {
                console.log(data);
            }
        })
    }
    
    function createRoom(data){
    
        console.log("calling create room api");
        $.ajax({
            url: 'https://100069.pythonanywhere.com/chat/create-room/',
            //url :'http://127.0.0.1:8000/chat/create-room/',
            type: 'POST',
            data: {
                'user_name': data['user_name'],
                'qrid': data['qrid'],
                'product': data['product']

            },
            success: function (data) {
                document.querySelector('#user_name').value = '';
                console.log(data);
                console.log(data['room_name']);
                //save data in request.session
                localStorage.setItem('room',data['room_name'])

                
                //redirect to chat.html page in the same directory
                window.location.href = 'chat.html';
                // window.location.href = 'https://github.com/LL04-Finance-Dowell/100069-dowellchat-frontend/chat.html';
                
            },
            error: function (data) {
                console.log(data);
            }
        })
    }
    

    //on page refresh , clear the form data and local storage
    window.onload = function(){
        document.querySelector('#user_name').value = '';
        //localStorage.clear();
    }
    
    </script>
</body>

</html>